<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оформление заказа - PC Tech Shop</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            background-color: #28a745;
        }

        .toast.error {
            background-color: #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Принудительные стили для checkout */
        body .checkout-container {
            max-width: 1200px !important;
            margin: 40px auto !important;
            padding: 0 20px !important;
        }

        body .checkout-layout {
            display: flex !important;
            flex-direction: row !important;
            gap: 30px !important;
            margin-bottom: 30px !important;
            align-items: flex-start !important;
        }

        body .checkout-form {
            background: #fff !important;
            padding: 30px !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            flex: 1 !important;
            min-width: 0 !important;
        }

        body .checkout-total-section {
            background: #fff !important;
            padding: 30px !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            width: 300px !important;
            height: fit-content !important;
            flex-shrink: 0 !important;
            position: sticky !important;
            top: 20px !important;
        }

        body .checkout-summary {
            background: #fff !important;
            padding: 30px !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            margin-bottom: 20px !important;
        }

        body .checkout-btn-section {
            background: #fff !important;
            padding: 30px !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            text-align: center !important;
        }

        body .form-group {
            margin-bottom: 20px !important;
        }

        body .form-group label {
            display: block !important;
            margin-bottom: 8px !important;
            font-weight: 500 !important;
        }

        body .form-group input,
        body .form-group textarea {
            width: 100% !important;
            padding: 12px !important;
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            font-size: 16px !important;
        }

        body .form-group textarea {
            min-height: 100px !important;
            resize: vertical !important;
        }

        body .checkout-items {
            margin-bottom: 20px !important;
        }

        body .checkout-item {
            display: flex !important;
            align-items: center !important;
            padding: 20px 0 !important;
            border-bottom: 1px solid #eee !important;
        }

        body .checkout-item:last-child {
            border-bottom: none !important;
        }

        body .checkout-item img {
            width: 120px !important;
            height: 120px !important;
            object-fit: contain !important;
            border-radius: 8px !important;
            margin-right: 20px !important;
            background: #f5f5f5 !important;
            padding: 10px !important;
        }

        body .checkout-item-info {
            flex: 1 !important;
        }

        body .checkout-item-title {
            font-size: 20px !important;
            font-weight: 600 !important;
            margin-bottom: 10px !important;
            color: #333 !important;
        }

        body .checkout-item-price {
            font-size: 18px !important;
            color: var(--primary-color) !important;
            font-weight: 500 !important;
        }

        body .checkout-total {
            margin-top: 20px !important;
            padding-top: 20px !important;
            border-top: 1px solid #eee !important;
        }

        body .checkout-total-row {
            display: flex !important;
            justify-content: space-between !important;
            margin-bottom: 15px !important;
            font-size: 18px !important;
        }

        body .checkout-total-row.final {
            font-size: 24px !important;
            font-weight: 600 !important;
            color: #333 !important;
            margin-top: 20px !important;
            padding: 15px !important;
            background: #f8f9fa !important;
            border-radius: 8px !important;
        }

        body .place-order-btn {
            width: 100% !important;
            padding: 15px !important;
            background: var(--primary-color) !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: background 0.3s !important;
        }

        body .place-order-btn:hover {
            background: var(--secondary-color) !important;
        }

        body .place-order-btn:disabled {
            background: #ccc !important;
            cursor: not-allowed !important;
        }

        body .payment-methods {
            margin: 20px 0 !important;
        }

        body .payment-method {
            display: flex !important;
            align-items: center !important;
            padding: 10px !important;
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            margin-bottom: 10px !important;
            cursor: pointer !important;
        }

        body .payment-method.selected {
            border-color: var(--primary-color) !important;
            background: #f0f7ff !important;
        }

        body .payment-method input {
            margin-right: 10px !important;
        }

        body .delivery-options {
            margin: 20px 0 !important;
        }

        body .delivery-option {
            display: flex !important;
            align-items: center !important;
            padding: 10px !important;
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            margin-bottom: 10px !important;
            cursor: pointer !important;
        }

        body .delivery-option.selected {
            border-color: var(--primary-color) !important;
            background: #f0f7ff !important;
        }

        body .delivery-option input {
            margin-right: 10px !important;
        }

        /* Стили для пустой корзины */
        body .empty-cart {
            text-align: center !important;
            padding: 60px 20px !important;
            color: #666 !important;
        }

        body .empty-cart i {
            font-size: 64px !important;
            margin-bottom: 20px !important;
            color: #ddd !important;
        }

        body .empty-cart p {
            font-size: 18px !important;
            margin: 0 !important;
        }

        /* Стили для заголовков */
        body h1, body h2, body h3 {
            color: var(--primary-color) !important;
            margin-bottom: 20px !important;
        }

        /* Стили для формы */
        body .form-group input:focus,
        body .form-group textarea:focus {
            border-color: var(--primary-color) !important;
            outline: none !important;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25) !important;
        }

        /* Стили для меню пользователя */
        body .user-menu {
            position: relative !important;
            display: none !important;
        }

        body .user-menu.active {
            display: block !important;
        }

        body .user-name {
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            cursor: pointer !important;
            padding: 8px 12px !important;
            border-radius: 4px !important;
            transition: background-color 0.3s !important;
        }

        body .user-name:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
        }

        body .user-dropdown {
            position: absolute !important;
            top: 100% !important;
            right: 0 !important;
            background: white !important;
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            display: none !important;
            min-width: 200px !important;
            z-index: 1000 !important;
        }

        body .user-dropdown.active {
            display: block !important;
        }

        body .user-dropdown a {
            display: block !important;
            padding: 10px 15px !important;
            color: #333 !important;
            text-decoration: none !important;
            transition: background-color 0.3s !important;
        }

        body .user-dropdown a:hover {
            background-color: #f5f5f5 !important;
        }

        /* Стили для корзины */
        body .cart-link {
            position: relative !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
        }

        body .cart-count {
            background-color: var(--primary-color) !important;
            color: white !important;
            border-radius: 50% !important;
            padding: 2px 6px !important;
            font-size: 12px !important;
            min-width: 18px !important;
            text-align: center !important;
        }

        body .order-item {
            display: flex !important;
            align-items: flex-start !important;
            padding: 20px !important;
            border-bottom: 1px solid #eee !important;
            transition: background-color 0.3s !important;
        }

        body .order-item:hover {
            background-color: #f9f9f9 !important;
        }

        body .order-item:last-child {
            border-bottom: none !important;
        }

        body .order-item img {
            width: 200px !important;
            height: 200px !important;
            object-fit: contain !important;
            border-radius: 8px !important;
            margin-right: 20px !important;
            background: #f5f5f5 !important;
            padding: 10px !important;
        }

        body .order-item-info {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 15px !important;
        }

        body .order-item-title {
            font-size: 24px !important;
            font-weight: 600 !important;
            margin-bottom: 10px !important;
            color: #333 !important;
        }

        body .order-item-description {
            color: #666 !important;
            font-size: 16px !important;
            line-height: 1.5 !important;
            margin-bottom: 15px !important;
        }

        body .order-item-price {
            font-size: 24px !important;
            font-weight: 600 !important;
            color: var(--primary-color) !important;
            margin: 10px 0 !important;
        }

        body .order-item-quantity {
            font-size: 16px !important;
            color: #666 !important;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            body .checkout-layout {
                flex-direction: column !important;
                gap: 20px !important;
            }

            body .checkout-total-section {
                width: 100% !important;
                order: 2 !important;
                position: static !important;
            }

            body .checkout-form {
                order: 1 !important;
            }

            body .checkout-item {
                flex-direction: column !important;
                align-items: flex-start !important;
                padding: 25px 0 !important;
            }

            body .checkout-item img {
                width: 100% !important;
                height: 200px !important;
                margin-bottom: 20px !important;
            }

            body .checkout-item-title {
                font-size: 22px !important;
            }

            body .checkout-item-price {
                font-size: 20px !important;
            }
        }

        /* Стили для модального окна */
        body .modal {
            display: none !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0, 0, 0, 0.5) !important;
            z-index: 1000 !important;
        }

        body .modal-content {
            position: relative !important;
            background-color: #fff !important;
            margin: 5% auto !important;
            padding: 20px !important;
            width: 80% !important;
            max-width: 800px !important;
            border-radius: 8px !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
        }

        body .close-modal {
            position: absolute !important;
            right: 20px !important;
            top: 20px !important;
            font-size: 24px !important;
            cursor: pointer !important;
            color: #666 !important;
        }

        body .close-modal:hover {
            color: #333 !important;
        }

        body .build-details {
            display: flex !important;
            gap: 20px !important;
            margin-top: 20px !important;
        }

        body .build-image {
            flex: 0 0 300px !important;
        }

        body .build-image img {
            width: 100% !important;
            height: auto !important;
            border-radius: 8px !important;
            object-fit: cover !important;
        }

        body .build-info {
            flex: 1 !important;
        }

        body .component-list {
            margin-top: 20px !important;
        }

        body .component-item {
            background: #f8f9fa !important;
            padding: 15px !important;
            border-radius: 8px !important;
            margin-bottom: 10px !important;
        }

        body .component-item h4 {
            margin: 0 0 10px 0 !important;
            color: #2c3e50 !important;
        }

        body .component-item p {
            margin: 5px 0 !important;
            color: #666 !important;
        }

        body .view-details-btn {
            background: var(--primary-color) !important;
            color: white !important;
            border: none !important;
            padding: 8px 16px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            margin-top: 10px !important;
            transition: background 0.3s !important;
        }

        body .view-details-btn:hover {
            background: var(--secondary-color) !important;
        }

        /* Стили для индикатора загрузки */
        body .loading-spinner {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 60px 20px !important;
            color: #666 !important;
        }

        body .spinner {
            width: 50px !important;
            height: 50px !important;
            border: 4px solid #f3f3f3 !important;
            border-top: 4px solid var(--primary-color) !important;
            border-radius: 50% !important;
            animation: spin 1s linear infinite !important;
            margin-bottom: 20px !important;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        body .loading-text {
            font-size: 18px !important;
            color: #666 !important;
            text-align: center !important;
            margin-bottom: 10px !important;
        }

        body .loading-subtext {
            font-size: 14px !important;
            color: #999 !important;
            text-align: center !important;
        }

        /* Новые стили для маленького индикатора загрузки */
        body .loading-spinner-small {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 20px !important;
            color: #666 !important;
        }

        body .spinner-small {
            width: 20px !important;
            height: 20px !important;
            border: 2px solid #f3f3f3 !important;
            border-top: 2px solid var(--primary-color) !important;
            border-radius: 50% !important;
            animation: spin-small 1s linear infinite !important;
            margin-bottom: 10px !important;
        }

        @keyframes spin-small {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        body .loading-text-small {
            font-size: 14px !important;
            color: #999 !important;
            text-align: center !important;
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <h1>PC Tech Shop</h1>
            </div>
            <div class="nav-links">
                <a href="index.html">Главная</a>
                <a href="builds.html">Готовые сборки</a>
                <a href="news.html">Новости</a>
                <a href="articles.html">Статьи</a>
                <a href="faq.html">FAQ</a>
                <a href="cart.html" class="cart-link">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </a>
                <div class="user-menu">
                    <span class="user-name">
                        <i class="fas fa-user"></i>
                        <span id="userDisplayName">Загрузка...</span>
                        <i class="fas fa-chevron-down"></i>
                    </span>
                    <div class="user-dropdown">
                        <a href="profile.html">Мой профиль</a>
                        <a href="admin.html" class="admin-panel-link">Панель администратора</a>
                        <a href="#" id="logoutBtn">Выйти</a>
                    </div>
                </div>
                <a href="login.html" class="login-link">Войти</a>
            </div>
        </nav>
    </header>

    <main>
        <div class="checkout-container">
            <div class="checkout-layout">
                <div class="checkout-form">
                    <h1>Оформление заказа</h1>
                    <form id="checkoutForm">
                        <div class="form-group">
                            <label for="name">Имя</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="surname">Фамилия</label>
                            <input type="text" id="surname" name="surname" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Телефон</label>
                            <input type="tel" id="phone" name="phone" required>
                        </div>
                        <div class="form-group">
                            <label for="address">Адрес доставки</label>
                            <textarea id="address" name="address" required></textarea>
                        </div>

                        <div class="delivery-options">
                            <h3>Способ доставки</h3>
                            <div class="delivery-option">
                                <input type="radio" name="delivery" id="delivery1" value="courier" checked>
                                <label for="delivery1">Курьерская доставка (фиксированная стоимость 2500 руб.)</label>
                            </div>
                            <div class="delivery-option">
                                <input type="radio" name="delivery" id="delivery2" value="pickup">
                                <label for="delivery2">Самовывоз (бесплатно)</label>
                            </div>
                        </div>

                        <div class="payment-methods">
                            <h3>Способ оплаты</h3>
                            <div class="payment-method">
                                <input type="radio" name="payment" id="payment1" value="card" checked>
                                <label for="payment1">Банковская карта</label>
                            </div>
                            <div class="payment-method">
                                <input type="radio" name="payment" id="payment2" value="cash">
                                <label for="payment2">Наличными при получении</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="comment">Комментарий к заказу</label>
                            <textarea id="comment" name="comment"></textarea>
                        </div>
                    </form>
                </div>

                <div class="checkout-total-section">
                    <h2>Итого</h2>
                    <div class="checkout-total">
                        <!-- Индикатор загрузки для итогов -->
                        <div class="loading-spinner-small" id="totalLoadingSpinner">
                            <div class="spinner-small"></div>
                            <div class="loading-text-small">Загрузка...</div>
                        </div>
                        
                        <!-- Итоговые суммы (скрыты во время загрузки) -->
                        <div class="checkout-total-content" id="checkoutTotalContent" style="display: none;">
                            <div class="checkout-total-row">
                                <span>Сумма товаров:</span>
                                <span id="subtotal">0 руб.</span>
                            </div>
                            <div class="checkout-total-row">
                                <span>Доставка:</span>
                                <span id="deliveryCost">0 руб.</span>
                            </div>
                            <div class="checkout-total-row final">
                                <span>Итого:</span>
                                <span id="total">0 руб.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="checkout-summary">
                <h2>Ваш заказ</h2>
                <div class="checkout-items" id="checkoutItems">
                    <!-- Индикатор загрузки -->
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner"></div>
                        <div class="loading-text">Пожалуйста, подождите</div>
                        <div class="loading-subtext">Загрузка данных о заказе...</div>
                    </div>
                    <!-- Товары будут добавлены через JavaScript -->
                </div>
            </div>

            <div class="checkout-btn-section">
                <button class="place-order-btn" id="placeOrderBtn">Оформить заказ</button>
            </div>
        </div>

        <!-- Модальное окно с подробной информацией о сборке -->
        <div id="buildDetailsModal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <div class="build-details">
                    <div class="build-image">
                        <img id="modalBuildImage" src="" alt="">
                    </div>
                    <div class="build-info">
                        <h2 id="modalBuildName"></h2>
                        <p id="modalBuildDescription"></p>
                        <div class="component-list" id="modalComponentList">
                            <!-- Компоненты будут добавлены через JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>О нас</h3>
                    <p>PC Tech Shop - ваш надежный помощник в выборе и покупке компьютерной техники. Мы предлагаем только качественные товары по лучшим ценам.</p>
                </div>
                <div class="footer-section">
                    <h3>Контакты</h3>
                    <p><i class="fas fa-phone"></i> +7 (993) 746-99-58</p>
                    <p><i class="fas fa-envelope"></i> pc-tech-magazine@yandex.ru</p>
                    <p><i class="fas fa-map-marker-alt"></i> г. Гусь-Хрустальный, ул. Микройрайон, д. 45</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 PC Tech Shop. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <script src="js/config.js"></script>
    <script src="js/common.js"></script>
    <script src="js/toast.js"></script>
    <script>
        let subtotalValue = 0; // Глобальная переменная для суммы товаров

        // Проверяем наличие API_CONFIG
        if (typeof API_CONFIG === 'undefined') {
            console.error('API_CONFIG не определен. Проверьте загрузку config.js');
            showToast('Ошибка конфигурации. Пожалуйста, обновите страницу.', 'error');
        }

        // Функции для отображения уведомлений
        function showError(message) {
            showToast(message, 'error');
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        // Функция для загрузки данных корзины
        async function loadCartData() {
            try {
                const token = localStorage.getItem('token');
                
                // Проверяем существование элементов
                const cartItemsContainer = document.getElementById('checkoutItems');
                const totalLoadingSpinner = document.getElementById('totalLoadingSpinner');
                const checkoutTotalContent = document.getElementById('checkoutTotalContent');
                
                console.log('Проверка элементов:', {
                    cartItemsContainer: !!cartItemsContainer,
                    totalLoadingSpinner: !!totalLoadingSpinner,
                    checkoutTotalContent: !!checkoutTotalContent
                });
                
                // Показываем индикатор загрузки в списке товаров
                if (cartItemsContainer) {
                    cartItemsContainer.innerHTML = `
                        <div class="loading-spinner" id="loadingSpinner">
                            <div class="spinner"></div>
                            <div class="loading-text">Пожалуйста, подождите</div>
                            <div class="loading-subtext">Загрузка данных о заказе...</div>
                        </div>
                    `;
                }

                // Показываем индикатор загрузки в блоке "Итого"
                if (totalLoadingSpinner) {
                    totalLoadingSpinner.style.display = 'flex';
                    console.log('Показан индикатор загрузки в блоке "Итого"');
                }
                if (checkoutTotalContent) {
                    checkoutTotalContent.style.display = 'none';
                    console.log('Скрыты итоговые суммы');
                }

                const response = await fetch(`${API_CONFIG.BASE_URL}/cart`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка при загрузке корзины');
                }

                const cart = await response.json();
                console.log('Данные корзины:', cart);

                if (!cartItemsContainer) {
                    console.error('Элемент checkoutItems не найден');
                    return;
                }

                // Показываем прогресс загрузки компонентов
                cartItemsContainer.innerHTML = `
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner"></div>
                        <div class="loading-text">Загрузка компонентов...</div>
                        <div class="loading-subtext">Подготовка данных товаров</div>
                    </div>
                `;

                let totalPrice = 0;

                // Проверяем, что cart - это массив
                if (!Array.isArray(cart)) {
                    console.error('Неверный формат данных корзины:', cart);
                    cartItemsContainer.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart"></i>
                            <p>Корзина пуста</p>
                        </div>
                    `;
                    
                    // Скрываем индикатор загрузки и показываем итоговые суммы
                    if (totalLoadingSpinner) {
                        totalLoadingSpinner.style.display = 'none';
                    }
                    if (checkoutTotalContent) {
                        checkoutTotalContent.style.display = 'block';
                    }
                    return;
                }

                // Очищаем контейнер для товаров
                cartItemsContainer.innerHTML = '';

                for (const item of cart) {
                    console.log('Обрабатываем товар:', item);
                    console.log('Цена сборки:', item.build?.total_price);
                    console.log('Количество:', item.quantity);
                    
                    // Проверяем, что данные существуют
                    if (!item.build) {
                        console.error('Отсутствуют данные о сборке:', item);
                        throw new Error('Отсутствуют данные о товаре');
                    }
                    
                    // Проверяем разные варианты названия поля цены
                    const price = item.build.total_price || item.build.TotalPrice || item.build.totalPrice || 0;
                    
                    if (!price || price <= 0) {
                        console.error('Отсутствует или некорректная цена:', item.build);
                        throw new Error('Отсутствует цена товара');
                    }
                    
                    // Преобразуем в числа
                    const numericPrice = parseFloat(price) || 0;
                    const quantity = parseInt(item.quantity) || 1;
                    
                    console.log('Обработанная цена:', numericPrice);
                    console.log('Обработанное количество:', quantity);
                    
                    const itemTotal = numericPrice * quantity;
                    console.log('Сумма за товар:', itemTotal);
                    
                    totalPrice += itemTotal;
                    
                    const itemElement = document.createElement('div');
                    itemElement.className = 'checkout-item';
                    itemElement.innerHTML = `
                        <div class="item-image">
                            <img src="${item.build.image_url ? (item.build.image_url.startsWith('http') ? item.build.image_url : API_CONFIG.BASE_URL + item.build.image_url) : `${API_CONFIG.BASE_URL}/images/builds/default.jpg`}" 
                                 alt="${item.build.name}"
                                 onerror="this.onerror=null; this.src='../assets/default-build.jpg';">
                        </div>
                        <div class="item-details">
                            <h3>${item.build.name}</h3>
                            <p class="item-price">${itemTotal.toLocaleString()} ₽</p>
                            <p class="item-quantity">Количество: ${quantity}</p>
                            <button class="view-details-btn" onclick="showBuildDetails(${item.build.id})">
                                Посмотреть подробную информацию
                            </button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                }

                // Если корзина пуста, показываем сообщение
                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart"></i>
                            <p>Корзина пуста</p>
                        </div>
                    `;
                }

                console.log('Итоговая сумма:', totalPrice);

                // Скрываем индикатор загрузки и показываем итоговые суммы
                console.log('Скрываем индикатор загрузки...');
                if (totalLoadingSpinner) {
                    totalLoadingSpinner.style.display = 'none';
                    console.log('Индикатор загрузки скрыт');
                } else {
                    console.log('Элемент totalLoadingSpinner не найден');
                }
                if (checkoutTotalContent) {
                    checkoutTotalContent.style.display = 'block';
                    console.log('Итоговые суммы показаны');
                } else {
                    console.log('Элемент checkoutTotalContent не найден');
                }

                // Обновляем стоимость доставки (фиксированная 2500 руб. только если выбран курьер)
                let deliveryCost = 0;
                const deliveryMethod = document.querySelector('input[name="delivery"]:checked');
                if (deliveryMethod && deliveryMethod.value === 'courier') {
                    deliveryCost = 2500;
                }
                const formattedDeliveryCost = deliveryCost.toLocaleString('ru-RU');
                const finalTotal = totalPrice + deliveryCost;
                const formattedFinalTotal = finalTotal.toLocaleString('ru-RU');

                // Обновляем стоимость доставки
                const deliveryCostElement = document.getElementById('deliveryCost');
                if (deliveryCostElement) {
                    deliveryCostElement.textContent = `${formattedDeliveryCost} ₽${deliveryCost > 0 ? ' (фиксированная стоимость доставки)' : ' (бесплатно)'}`;
                }

                // Обновляем итоговую сумму
                const subtotalElement = document.getElementById('subtotal');
                const totalElement = document.getElementById('total');
                if (subtotalElement) {
                    subtotalElement.textContent = `${totalPrice.toLocaleString('ru-RU')} ₽`;
                }
                if (totalElement) {
                    totalElement.textContent = `${formattedFinalTotal} ₽`;
                }
                
                console.log('Загрузка завершена успешно');

                subtotalValue = totalPrice; // Сохраняем сумму товаров для пересчёта доставки
            } catch (error) {
                console.error('Ошибка при загрузке корзины:', error);
                showError('Произошла ошибка при загрузке корзины');
                
                // Показываем сообщение об ошибке
                const cartItemsContainer = document.getElementById('checkoutItems');
                if (cartItemsContainer) {
                    cartItemsContainer.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Ошибка при загрузке данных</p>
                        </div>
                    `;
                }

                // Скрываем индикатор загрузки в блоке "Итого" и показываем нулевые суммы
                const totalLoadingSpinner = document.getElementById('totalLoadingSpinner');
                const checkoutTotalContent = document.getElementById('checkoutTotalContent');
                if (totalLoadingSpinner) {
                    totalLoadingSpinner.style.display = 'none';
                }
                if (checkoutTotalContent) {
                    checkoutTotalContent.style.display = 'block';
                }
            } finally {
                // Принудительно скрываем загрузку в любом случае
                console.log('Принудительное скрытие загрузки...');
                const totalLoadingSpinner = document.getElementById('totalLoadingSpinner');
                const checkoutTotalContent = document.getElementById('checkoutTotalContent');
                
                if (totalLoadingSpinner) {
                    totalLoadingSpinner.style.display = 'none';
                    console.log('Загрузка скрыта (finally)');
                }
                if (checkoutTotalContent) {
                    checkoutTotalContent.style.display = 'block';
                    console.log('Итоговые суммы показаны (finally)');
                }
            }
        }

        // Функция для проверки авторизации и загрузки данных пользователя
        async function checkAuthAndLoadUserData() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || !user) {
                showError('Требуется авторизация');
                window.location.href = 'login.html';
                return false;
            }

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        localStorage.removeItem('role');
                        showError('Сессия истекла. Пожалуйста, войдите снова.');
                        window.location.href = 'login.html';
                        return false;
                    }
                    throw new Error('Ошибка при проверке авторизации');
                }

                const userData = await response.json();
                console.log('Данные пользователя:', userData);
                
                // Заполняем форму данными пользователя
                document.getElementById('name').value = userData.name || '';
                document.getElementById('surname').value = userData.surname || '';
                document.getElementById('email').value = userData.email || '';
                document.getElementById('phone').value = userData.phone || '';
                
                // Обновляем UI
                updateAuthUI(userData);
                
                return true;
            } catch (error) {
                console.error('Ошибка при проверке авторизации:', error);
                showError('Произошла ошибка при загрузке данных пользователя');
                return false;
            }
        }

        // Функция для обновления UI в зависимости от статуса авторизации
        function updateAuthUI(userData) {
            const loginLink = document.querySelector('.login-link');
            const userMenu = document.querySelector('.user-menu');
            const userDropdown = document.querySelector('.user-dropdown');
            
            if (userData) {
                // Скрываем ссылку на вход
                if (loginLink) {
                    loginLink.style.display = 'none';
                }
                
                // Показываем меню пользователя
                if (userMenu) {
                    userMenu.style.display = 'block';
                }
                
                // Обновляем имя пользователя
                const userDisplayName = document.getElementById('userDisplayName');
                if (userDisplayName) {
                    userDisplayName.textContent = userData.name ? `${userData.name} ${userData.surname}`.trim() : userData.email || 'Гость';
                }

                // Добавляем обработчики для выпадающего меню
                const userName = document.querySelector('.user-name');
                if (userName) {
                    userName.addEventListener('click', (e) => {
                        e.stopPropagation();
                        userDropdown.classList.toggle('active');
                    });
                }

                // Закрываем меню при клике вне его
                document.addEventListener('click', (e) => {
                    if (!userMenu.contains(e.target)) {
                        userDropdown.classList.remove('active');
                    }
                });
            } else {
                // Показываем ссылку на вход
                if (loginLink) {
                    loginLink.style.display = 'block';
                }
                
                // Скрываем меню пользователя
                if (userMenu) {
                    userMenu.style.display = 'none';
                }
            }
        }

        // Функция для обновления количества товаров в корзине
        async function updateCartCount() {
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/cart`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const cartData = await response.json();
                    const cartCount = document.querySelector('.cart-count');
                    if (cartCount) {
                        cartCount.textContent = cartData.length || 0;
                    }
                }
            } catch (error) {
                console.error('Ошибка при обновлении количества товаров в корзине:', error);
            }
        }

        // Инициализация страницы
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Инициализация страницы checkout...');
            
            // Проверяем авторизацию и загружаем данные пользователя
            const isAuth = await checkAuthAndLoadUserData();
            if (!isAuth) {
                return;
            }
            
            // Загружаем данные корзины
            await loadCartData();
            
            // Обновляем счетчик корзины
            await updateCartCount();
            
            // Добавляем обработчики для изменения способа доставки
            const deliveryOptions = document.querySelectorAll('input[name="delivery"]');
            deliveryOptions.forEach(option => {
                option.addEventListener('change', updateDeliveryCost);
            });
            
            // Добавляем обработчик для кнопки оформления заказа
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            if (placeOrderBtn) {
                placeOrderBtn.addEventListener('click', handlePlaceOrder);
            }
            
            // Добавляем обработчик для выхода
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    localStorage.removeItem('role');
                    window.location.href = 'login.html';
                });
            }

            // Добавляем обработчик для выпадающего меню профиля
            const userMenu = document.querySelector('.user-menu');
            if (userMenu) {
                userMenu.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const dropdown = userMenu.querySelector('.user-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                });
                // Закрываем меню при клике вне его
                document.addEventListener('click', function() {
                    const dropdown = userMenu.querySelector('.user-dropdown');
                    if (dropdown) dropdown.style.display = 'none';
                });
            }
        });

        // Функция для обновления стоимости доставки
        function updateDeliveryCost() {
            const deliveryCostElement = document.getElementById('deliveryCost');
            const totalElement = document.getElementById('total');
            if (!deliveryCostElement || !totalElement) return;
            let deliveryCost = 0;
            const deliveryMethod = document.querySelector('input[name="delivery"]:checked');
            if (deliveryMethod && deliveryMethod.value === 'courier') {
                deliveryCost = 2500;
            }
            const formattedDeliveryCost = deliveryCost.toLocaleString('ru-RU');
            const finalTotal = subtotalValue + deliveryCost;
            const formattedFinalTotal = finalTotal.toLocaleString('ru-RU');
            deliveryCostElement.textContent = `${formattedDeliveryCost} ₽${deliveryCost > 0 ? ' (фиксированная стоимость доставки)' : ' (бесплатно)'}`;
            totalElement.textContent = `${formattedFinalTotal} ₽`;
        }

        // Функция для обработки оформления заказа
        async function handlePlaceOrder() {
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            if (placeOrderBtn) {
                placeOrderBtn.disabled = true;
                placeOrderBtn.textContent = 'Оформление заказа...';
            }

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showError('Требуется авторизация');
                    window.location.href = 'login.html';
                    return;
                }

                // Получаем товары из корзины
                const cartResponse = await fetch(`${API_CONFIG.BASE_URL}/cart`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!cartResponse.ok) {
                    throw new Error('Не удалось получить данные корзины');
                }

                const cartItems = await cartResponse.json();
                
                if (!cartItems || cartItems.length === 0) {
                    showError('Корзина пуста');
                    return;
                }

                // Рассчитываем общую сумму только по товарам
                let totalAmount = 0;
                const orderItems = [];
                cartItems.forEach(item => {
                    if (!item.build) throw new Error('Отсутствуют данные о товаре');
                    const price = item.build.total_price || item.build.TotalPrice || item.build.totalPrice || 0;
                    const numericPrice = parseFloat(price) || 0;
                    const quantity = parseInt(item.quantity) || 1;
                    const itemTotal = numericPrice * quantity;
                    totalAmount += itemTotal;
                    orderItems.push({ build_id: item.build.id, quantity: quantity, price: numericPrice });
                });
                // Стоимость доставки: фиксированная 2500 руб. только если выбран курьер
                let deliveryCost = 0;
                const deliveryMethod = document.querySelector('input[name="delivery"]:checked');
                if (deliveryMethod && deliveryMethod.value === 'courier') {
                    deliveryCost = 2500;
                }
                totalAmount += deliveryCost;

                // Проверяем, что сумма заказа больше 0
                if (totalAmount <= 0) {
                    showError('Сумма заказа должна быть больше 0');
                    return;
                }

                // Получаем данные формы
                const formData = {
                    total_amount: totalAmount,
                    status: 'pending',
                    shipping_address: document.getElementById('address').value,
                    payment_method: document.querySelector('input[name="payment"]:checked')?.value || 'card',
                    delivery_method: document.querySelector('input[name="delivery"]:checked')?.value || 'pickup',
                    comment: document.getElementById('comment').value,
                    items: orderItems
                };

                if (!document.getElementById('name').value || 
                    !document.getElementById('surname').value || 
                    !document.getElementById('email').value || 
                    !document.getElementById('phone').value || 
                    !document.getElementById('address').value) {
                    showError('Пожалуйста, заполните все обязательные поля');
                    return;
                }

                const response = await fetch(`${API_CONFIG.BASE_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const responseData = await response.json();
                    throw new Error(responseData.error || 'Не удалось оформить заказ');
                }

                const orderData = await response.json();
                await fetch(`${API_CONFIG.BASE_URL}/cart`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                showSuccess('Заказ успешно оформлен!');
                setTimeout(() => {
                    window.location.href = 'profile.html?refresh=true';
                }, 2000);
            } catch (error) {
                showError(error.message || 'Произошла ошибка при оформлении заказа');
            } finally {
                if (placeOrderBtn) {
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.textContent = 'Оформить заказ';
                }
            }
        }

        // Функция для отображения товаров в заказе
        function displayOrderItems(items) {
            const orderItemsContainer = document.getElementById('orderItems');
            const orderTotal = document.getElementById('orderTotal');
            const subtotal = document.getElementById('subtotal');

            if (!items || items.length === 0) {
                orderItemsContainer.innerHTML = '<p>Нет товаров в заказе</p>';
                orderTotal.textContent = '0 руб.';
                subtotal.textContent = '0 руб.';
                return;
            }

            let total = 0;
            orderItemsContainer.innerHTML = '';

            items.forEach(item => {
                if (!item.build) {
                    console.error('Отсутствуют данные о сборке:', item);
                    return;
                }

                let imageUrl = item.build.image_url;
                if (imageUrl && !imageUrl.startsWith('http')) {
                    imageUrl = API_CONFIG.BASE_URL + imageUrl;
                }

                // Проверяем разные варианты названия поля цены
                const price = item.build.total_price || item.build.TotalPrice || item.build.totalPrice || 0;
                const quantity = parseInt(item.quantity) || 1;
                const itemTotal = price * quantity;
                total += itemTotal;

                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                orderItem.innerHTML = `
                    <img src="${imageUrl}" alt="${item.build.name}" onerror="this.onerror=null; this.src='../assets/default-build.jpg'">
                    <div class="order-item-info">
                        <h3 class="order-item-title">${item.build.name}</h3>
                        <p class="order-item-description">${item.build.description || 'Описание отсутствует'}</p>
                        <div class="order-item-price">${itemTotal.toLocaleString()} ₽</div>
                        <div class="order-item-quantity">Количество: ${quantity}</div>
                    </div>
                `;
                orderItemsContainer.appendChild(orderItem);
            });

            orderTotal.textContent = `${total.toLocaleString()} ₽`;
            subtotal.textContent = `${total.toLocaleString()} ₽`;
        }

        // Функция для отображения подробной информации о сборке
        async function showBuildDetails(id) {
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/builds/${id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных сборки');
                }

                const build = await response.json();
                console.log('Данные сборки:', build);

                const modal = document.getElementById('buildDetailsModal');
                const modalImage = document.getElementById('modalBuildImage');
                const modalName = document.getElementById('modalBuildName');
                const modalDescription = document.getElementById('modalBuildDescription');

                // Обработка URL изображения в модальном окне
                let imageUrl = build.image_url;
                if (imageUrl && !imageUrl.startsWith('http')) {
                    imageUrl = API_CONFIG.BASE_URL + imageUrl;
                }
                modalImage.src = imageUrl || '../assets/default-build.jpg';
                modalImage.onerror = function() {
                    this.onerror = null;
                    this.src = '../assets/default-build.jpg';
                };

                modalName.textContent = build.name;
                modalDescription.textContent = build.description || 'Описание отсутствует';

                // Формируем список компонентов
                const componentList = document.getElementById('modalComponentList');
                componentList.innerHTML = `
                    <div class="component-item">
                        <h4>Процессор</h4>
                        <p>${build.cpu ? build.cpu.name : 'Не указан'}</p>
                        ${build.cpu ? `<p>${build.cpu.cores} ядер, ${build.cpu.threads} потоков</p>` : ''}
                    </div>
                    <div class="component-item">
                        <h4>Видеокарта</h4>
                        <p>${build.gpu ? build.gpu.name : 'Не указана'}</p>
                        ${build.gpu ? `<p>${build.gpu.memory} ГБ ${build.gpu.memory_type}</p>` : ''}
                    </div>
                    <div class="component-item">
                        <h4>Материнская плата</h4>
                        <p>${build.motherboard ? build.motherboard.name : 'Не указана'}</p>
                        ${build.motherboard ? `<p>Чипсет: ${build.motherboard.chipset}</p>` : ''}
                    </div>
                    <div class="component-item">
                        <h4>Оперативная память</h4>
                        <p>${build.ram ? build.ram.name : 'Не указана'}</p>
                        ${build.ram ? `<p>${build.ram.capacity} ГБ ${build.ram.ddr}</p>` : ''}
                    </div>
                    <div class="component-item">
                        <h4>Блок питания</h4>
                        <p>${build.power_unit ? build.power_unit.name : 'Не указан'}</p>
                        ${build.power_unit ? `<p>${build.power_unit.wattage} Вт</p>` : ''}
                    </div>
                    <div class="component-item">
                        <h4>Корпус</h4>
                        <p>${build.body ? build.body.name : 'Не указан'}</p>
                        ${build.body ? `<p>Производитель: ${build.body.manufacturer}</p>` : ''}
                    </div>
                `;

                modal.style.display = 'block';

                // Добавляем обработчик закрытия
                const closeBtn = modal.querySelector('.close-modal');
                closeBtn.onclick = function() {
                    modal.style.display = 'none';
                };

                // Закрытие по клику вне модального окна
                window.onclick = function(event) {
                    if (event.target == modal) {
                        modal.style.display = 'none';
                    }
                };
            } catch (error) {
                console.error('Ошибка при загрузке данных сборки:', error);
                alert('Произошла ошибка при загрузке данных сборки');
            }
        }

        // Явно обновляем UI профиля пользователя при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof updateAuthUI === 'function') {
                updateAuthUI(JSON.parse(localStorage.getItem('user') || '{}'));
            }
            // Принудительно показываем user-menu, если есть user и token
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = localStorage.getItem('token');
            if (user && token && document.querySelector('.user-menu')) {
                document.querySelector('.user-menu').style.display = 'block';
                document.querySelector('.login-link').style.display = 'none';
            }
        });
    </script>
</body>
</html> 