<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Корзина - PC Tech Shop</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <h1>PC Tech Shop</h1>
            </div>
            <div class="nav-links">
                <a href="index.html">Главная</a>
                <a href="builds.html">Готовые сборки</a>
                <a href="cart.html" class="active cart-link">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </a>
                <a href="login.html" class="login-link">Войти</a>
                <div class="user-menu" style="display: none;">
                    <span class="user-name">
                        <i class="fas fa-user"></i>
                        <span id="userDisplayName"></span>
                        <i class="fas fa-chevron-down"></i>
                    </span>
                    <div class="user-dropdown">
                        <a href="profile.html">Мой профиль</a>
                        <a href="admin.html" class="admin-panel-link" style="display: none;">Панель администратора</a>
                        <a href="#" id="logoutBtn">Выйти</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <div class="container">
            <div class="cart-section">
                <h1>Корзина</h1>
                <div class="cart-items">
                    <!-- Здесь будут отображаться товары -->
                </div>
                <div class="cart-summary">
                    <div class="cart-total">
                        <span>Итого:</span>
                        <span id="cart-total">0 ₽</span>
                    </div>
                    <button class="checkout-button" onclick="checkout()">Оформить заказ</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>О нас</h3>
                    <p>PC Tech Shop - ваш надежный помощник в выборе и сборке компьютера. Мы предлагаем качественные компоненты и готовые сборки по лучшим ценам.</p>
                </div>
                <div class="footer-section">
                    <h3>Контакты</h3>
                    <p><i class="fas fa-phone"></i> +7 (999) 123-45-67</p>
                    <p><i class="fas fa-envelope"></i> info@pctechshop.ru</p>
                    <p><i class="fas fa-map-marker-alt"></i> г. Москва, ул. Примерная, д. 123</p>
                </div>
                <div class="footer-section">
                    <h3>Социальные сети</h3>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-vk"></i></a>
                        <a href="#"><i class="fab fa-telegram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 PC Tech Shop. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <script src="js/toast.js"></script>
    <script src="js/common.js"></script>
    <script>
        // Функция для обновления имени пользователя и меню
        function updateUserName() {
            const user = JSON.parse(localStorage.getItem('user'));
            const token = localStorage.getItem('token');
            const userDisplayName = document.getElementById('userDisplayName');
            const loginLink = document.querySelector('.login-link');
            const userMenu = document.querySelector('.user-menu');
            const adminPanelLink = document.querySelector('.admin-panel-link');

            if (user && token) {
                userDisplayName.textContent = user.name || user.email || 'Пользователь';
                loginLink.style.display = 'none';
                userMenu.style.display = 'block';
                
                // Проверяем роль пользователя
                if (user.role === 'admin') {
                    adminPanelLink.style.display = 'block';
                } else {
                    adminPanelLink.style.display = 'none';
                }
            } else {
                userDisplayName.textContent = '';
                loginLink.style.display = 'block';
                userMenu.style.display = 'none';
                adminPanelLink.style.display = 'none';
            }
        }

        // Функция для загрузки корзины
        async function loadCart() {
            const token = localStorage.getItem('token');
            if (!token) {
                showError('Необходима авторизация');
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch('http://localhost:8080/cart', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('Ответ сервера:', response.status, response.statusText);
                if (response.ok) {
                    const cartItems = await response.json();
                    console.log('Полученные товары корзины:', cartItems);
                    displayCartItems(cartItems);
                    updateTotal(cartItems);
                } else {
                    console.error('Ошибка при загрузке корзины');
                    showError('Не удалось загрузить корзину');
                }
            } catch (error) {
                console.error('Ошибка при загрузке корзины:', error);
                showError('Произошла ошибка при загрузке корзины');
            }
        }

        // Функция для отображения товаров в корзине
        function displayCartItems(items) {
            const cartContainer = document.querySelector('.cart-items');
            cartContainer.innerHTML = '';

            console.log('Отображение товаров корзины:', items);

            if (!items || items.length === 0) {
                cartContainer.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Корзина пуста</p>
                    </div>
                `;
                return;
            }

            items.forEach(item => {
                console.log('Обработка товара:', item);
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                
                // Получаем данные о сборке
                const build = item.build;
                if (!build) {
                    console.error('Нет данных о сборке:', item);
                    return;
                }

                cartItem.innerHTML = `
                    <div class="cart-item-image">
                        <img src="${build.image_url || 'images/placeholder.jpg'}" alt="${build.name}">
                    </div>
                    <div class="cart-item-info">
                        <h3>${build.name}</h3>
                        <p>${build.description}</p>
                        <p class="price">${build.total_price.toLocaleString()} ₽</p>
                        <p>Количество: ${item.quantity}</p>
                    </div>
                    <div class="cart-item-controls">
                        <button onclick="removeFromCart(${item.id})" class="remove-btn">
                            <i class="fas fa-trash"></i> Удалить
                        </button>
                    </div>
                `;
                cartContainer.appendChild(cartItem);
            });
        }

        // Обновляем функцию подсчета общей суммы
        function updateTotal(items) {
            const total = items.reduce((sum, item) => {
                const build = item.build;
                if (!build) return sum;
                return sum + (build.total_price * item.quantity);
            }, 0);
            document.getElementById('cart-total').textContent = `${total.toLocaleString()} ₽`;
        }

        // Функция для удаления товара из корзины
        async function removeFromCart(itemId) {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`http://localhost:8080/cart/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showSuccess('Товар удален из корзины');
                    loadCart(); // Перезагружаем корзину
                } else {
                    showError('Не удалось удалить товар из корзины');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Произошла ошибка при удалении товара');
            }
        }

        // Функция для оформления заказа
        async function checkout() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('http://localhost:8080/orders', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showSuccess('Заказ успешно оформлен');
                    loadCart(); // Перезагружаем корзину
                } else {
                    showError('Не удалось оформить заказ');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Произошла ошибка при оформлении заказа');
            }
        }

        // Загружаем корзину при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM загружен, начинаем инициализацию...');
            
            // Сначала загружаем корзину
            console.log('Загружаем корзину...');
            loadCart();
            
            // Затем обновляем UI
            console.log('Обновляем UI...');
            updateCartCount();
            updateUserName();

            // Добавляем обработчик для кнопки выхода
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.reload();
                });
            }

            // Добавляем обработчик для выпадающего меню
            const userMenu = document.querySelector('.user-menu');
            if (userMenu) {
                userMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const dropdown = userMenu.querySelector('.user-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                });

                // Закрываем меню при клике вне его
                document.addEventListener('click', () => {
                    const dropdown = userMenu.querySelector('.user-dropdown');
                    dropdown.style.display = 'none';
                });
            }
        });

        // Добавляем проверку загрузки скрипта
        console.log('Скрипт cart.html загружен');
    </script>
</body>
</html>